---
title: 'Autentica√ß√£o'
description: 'Sistema de autentica√ß√£o baseado em sess√£o com controle de acesso granular'
icon: 'key'
---

# Autentica√ß√£o da API

O Eleva AI utiliza um sistema h√≠brido de autentica√ß√£o baseado em **cookies de sess√£o seguros** com **JWT tokens** para integra√ß√£o com APIs externas.

## üîê Vis√£o Geral do Sistema

### Fluxo de Autentica√ß√£o

```mermaid
sequenceDiagram
    participant C as Cliente
    participant A as API Eleva
    participant S as Supabase
    participant R as Redis
    
    C->>A: POST /api/auth/login
    A->>S: Verificar credenciais
    S-->>A: Dados do usu√°rio
    A->>R: Criar sess√£o
    R-->>A: Session ID
    A-->>C: Set-Cookie: session=...
    
    Note over C,A: Requests subsequentes
    C->>A: GET /api/contacts (com cookie)
    A->>R: Validar sess√£o
    R-->>A: Dados do usu√°rio
    A->>A: Verificar permiss√µes
    A-->>C: Dados autorizados
```

### Componentes do Sistema

<CardGroup cols={2}>
  <Card title="Session Management" icon="clock">
    - Cookies seguros HTTPOnly
    - Expira√ß√£o autom√°tica
    - Invalida√ß√£o por logout
    - IP tracking para seguran√ßa
  </Card>
  
  <Card title="Access Control" icon="shield-alt">
    - RBAC: user/admin/superadmin
    - Instance-level permissions
    - Account isolation (multi-tenant)
    - API rate limiting
  </Card>
</CardGroup>

## üöÄ Login e Logout

### Fazer Login

<ParamField path="POST /api/auth/login" type="endpoint">
  Autentica usu√°rio e cria sess√£o segura
</ParamField>

**Request**:
```json
{
  "email": "usuario@empresa.com",
  "password": "senha-segura"
}
```

**Response Success (200)**:
```json
{
  "data": {
    "user": {
      "id": "uuid",
      "email": "usuario@empresa.com",
      "name": "Jo√£o Silva",
      "role": "admin",
      "accountId": "account-uuid"
    },
    "token": "optional-jwt-token"
  },
  "message": "Login realizado com sucesso"
}
```

**Response Error (401)**:
```json
{
  "error": "Email ou senha inv√°lidos"
}
```

### Fazer Logout

<ParamField path="POST /api/auth/logout" type="endpoint">
  Invalida sess√£o atual
</ParamField>

**Headers**:
```
Cookie: session=valor-da-sessao
```

**Response (200)**:
```json
{
  "message": "Logout realizado com sucesso"
}
```

### Verificar Sess√£o

<ParamField path="GET /api/auth/check" type="endpoint">
  Valida se sess√£o est√° ativa
</ParamField>

**Response (200)**:
```json
{
  "authenticated": true,
  "user": {
    "id": "uuid",
    "email": "usuario@empresa.com",
    "role": "admin"
  }
}
```

## üõ°Ô∏è Sistema de Permiss√µes

### N√≠veis de Acesso (RBAC)

<Tabs>
  <Tab title="user">
    **Permiss√µes**:
    - Visualizar pr√≥prias conversas
    - Gerenciar tarefas atribu√≠das
    - Acessar inst√¢ncias autorizadas
    - N√£o pode criar/deletar usu√°rios
    
    **Endpoints permitidos**:
    - `/api/conversations` (pr√≥pria account)
    - `/api/tasks` (pr√≥prias tarefas)
    - `/api/contacts` (inst√¢ncias autorizadas)
  </Tab>
  
  <Tab title="admin">
    **Permiss√µes**:
    - Gerenciar usu√°rios da pr√≥pria conta
    - Configurar inst√¢ncias WhatsApp
    - Acessar todas as conversas da conta
    - Configura√ß√µes avan√ßadas de IA
    
    **Endpoints adicionais**:
    - `/api/account/users`
    - `/api/instances/create`
    - `/api/assistant-config/*`
  </Tab>
  
  <Tab title="superadmin">
    **Permiss√µes**:
    - Acesso total ao sistema
    - Gerenciar m√∫ltiplas contas
    - Configurar sistema de federa√ß√£o
    - Debug e monitoring avan√ßado
    
    **Endpoints exclusivos**:
    - `/api/superadmin/*`
    - `/api/debug/*`
    - `/api/admin/*`
  </Tab>
</Tabs>

### Instance-Level Access Control

Cada usu√°rio s√≥ pode acessar inst√¢ncias WhatsApp espec√≠ficas:

```typescript
// Middleware de valida√ß√£o autom√°tica
async function validateInstanceAccess(instanceName: string) {
  const user = await getCurrentUser()
  const hasAccess = await validateUserInstanceAccess(instanceName)
  
  if (!hasAccess && !isSuperAdmin(user)) {
    throw new Error('Access denied to instance')
  }
}
```

**Exemplo de controle**:
```json
// Usuario A s√≥ acessa:
{
  "authorizedInstances": ["clinica-abc", "clinica-def"],
  "account_id": "account-123"
}

// Usuario B (outra conta) s√≥ acessa:
{
  "authorizedInstances": ["empresa-xyz"],
  "account_id": "account-456"  
}
```

## üîß Integra√ß√£o com APIs

### Usando Cookie de Sess√£o (Recomendado)

Para chamadas browser/frontend:

```javascript
// Fetch com cookies autom√°ticos
const response = await fetch('/api/conversations', {
  credentials: 'include' // Inclui cookies automaticamente
})

// Axios com cookies
axios.defaults.withCredentials = true
const response = await axios.get('/api/conversations')
```

### Usando JWT Token (APIs externas)

Para integra√ß√µes server-to-server:

```bash
# Obter token no login
TOKEN=$(curl -X POST /api/auth/login \
  -d '{"email":"user@example.com","password":"pass"}' \
  -H "Content-Type: application/json" \
  | jq -r '.data.token')

# Usar token em requests
curl -H "Authorization: Bearer $TOKEN" \
  /api/conversations
```

## üîí Middleware de Seguran√ßa

### getCurrentUser()

Utilit√°rio principal para verificar autentica√ß√£o:

```typescript
import { getCurrentUser } from '@/lib/auth-utils-local'

export async function GET(request: Request) {
  // Verifica√ß√£o autom√°tica de sess√£o
  const user = await getCurrentUser()
  
  if (!user) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 })
  }
  
  // User est√° autenticado
  console.log('User:', user.email, 'Role:', user.role)
}
```

### validateUserInstanceAccess()

Controle de acesso a inst√¢ncias:

```typescript
import { validateUserInstanceAccess } from '@/lib/auth-utils'

export async function GET(request: Request) {
  const instanceName = searchParams.get('instance')
  
  const accessCheck = await validateUserInstanceAccess(instanceName)
  
  if (!accessCheck.hasAccess) {
    return Response.json({ error: 'Access denied' }, { status: 403 })
  }
  
  // Acesso autorizado para a inst√¢ncia
}
```

### isSuperAdmin()

Verifica√ß√£o de permiss√µes administrativas:

```typescript
import { isSuperAdmin } from '@/lib/auth-utils'

export async function DELETE(request: Request) {
  const isSuper = await isSuperAdmin()
  
  if (!isSuper) {
    return Response.json({ error: 'Insufficient privileges' }, { status: 403 })
  }
  
  // Opera√ß√£o administrativa autorizada
}
```

## ‚öôÔ∏è Configura√ß√£o de Sess√µes

### Vari√°veis de Ambiente

```bash
# Chave de criptografia (OBRIGAT√ìRIO)
SESSION_SECRET=sua-chave-super-secreta-de-32-chars-ou-mais

# Configura√ß√µes Redis para sess√µes
REDIS_URL=redis://localhost:6379

# TTL padr√£o das sess√µes (opcional)
SESSION_TTL=86400  # 24 horas em segundos
```

### Configura√ß√µes de Cookie

As sess√µes usam cookies seguros com as seguintes configura√ß√µes:

```typescript
const cookieOptions = {
  name: 'session',
  httpOnly: true,        // Previne XSS
  secure: true,          // HTTPS apenas em produ√ß√£o
  sameSite: 'lax',       // Prote√ß√£o CSRF
  maxAge: 24 * 60 * 60,  // 24 horas
  path: '/'
}
```

## üîç Monitoring e Auditoria

### Audit Log

Todas as opera√ß√µes cr√≠ticas s√£o logadas:

```sql
-- Tabela audit_log
CREATE TABLE audit_log (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  action VARCHAR NOT NULL,         -- 'user.login', 'task.create', etc.
  resource_type VARCHAR NOT NULL,  -- 'session', 'task', 'message', etc.
  resource_id VARCHAR,
  details JSONB,                   -- IP, user_agent, etc.
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Exemplos de eventos auditados**:
- Login/logout de usu√°rios
- Cria√ß√£o/modifica√ß√£o de tarefas
- Mudan√ßas de configura√ß√£o
- Acesso a dados sens√≠veis

### Session Tracking

Informa√ß√µes rastreadas por sess√£o:

```json
{
  "user_id": "uuid",
  "email": "user@example.com", 
  "role": "admin",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0...",
  "created_at": "2024-09-03T10:00:00Z",
  "last_activity": "2024-09-03T10:30:00Z"
}
```

## üö® Troubleshooting de Autentica√ß√£o

### Problemas Comuns

<Accordion title="Sess√£o expira muito r√°pido" icon="clock">

**Causa**: TTL muito baixo ou Redis reiniciando

**Solu√ß√£o**:
```bash
# Verificar TTL das chaves de sess√£o
redis-cli TTL "session:uuid-da-sessao"

# Aumentar TTL se necess√°rio
SESSION_TTL=86400  # 24 horas
```

</Accordion>

<Accordion title="403 Forbidden em endpoints permitidos" icon="ban">

**Causa**: Usu√°rio n√£o tem acesso √† inst√¢ncia solicitada

**Diagn√≥stico**:
```bash
# Verificar permiss√µes do usu√°rio
curl -X GET /api/me/permissions \
  -H "Cookie: session=valor-sessao"

# Verificar inst√¢ncias autorizadas
curl -X GET /api/me/instances \
  -H "Cookie: session=valor-sessao"
```

</Accordion>

<Accordion title="Login funciona mas requests falham" icon="exclamation-triangle">

**Causa**: Cookies n√£o est√£o sendo enviados

**Solu√ß√µes**:
1. **Frontend**: Usar `credentials: 'include'` no fetch
2. **CORS**: Verificar se `withCredentials` est√° habilitado
3. **Domain**: Verificar se cookie domain est√° correto
4. **HTTPS**: Em produ√ß√£o, cookies secure precisam de HTTPS

</Accordion>

### Debug de Autentica√ß√£o

```bash
# Verificar sess√µes ativas no Redis
redis-cli KEYS "session:*" | head -10

# Ver detalhes de uma sess√£o
redis-cli GET "session:uuid-da-sessao"

# Verificar usu√°rio atual via API
curl -X GET /api/auth/check \
  -H "Cookie: session=valor-sessao" \
  -v  # Ver headers detalhados
```

## üìã Checklist de Implementa√ß√£o

Para implementar autentica√ß√£o em novos endpoints:

<Steps>
  <Step title="Adicionar Verifica√ß√£o de Usu√°rio">
    ```typescript
    const user = await getCurrentUser()
    if (!user) return unauthorizedResponse()
    ```
  </Step>
  
  <Step title="Validar Permiss√µes de Role">
    ```typescript
    if (user.role !== 'admin') return forbiddenResponse()
    // ou usar isSuperAdmin() para opera√ß√µes cr√≠ticas
    ```
  </Step>
  
  <Step title="Verificar Acesso a Inst√¢ncia (se aplic√°vel)">
    ```typescript
    const hasAccess = await validateUserInstanceAccess(instanceName)
    if (!hasAccess) return forbiddenResponse()
    ```
  </Step>
  
  <Step title="Implementar Rate Limiting">
    ```typescript
    await rateLimitByUser(user.id, { window: '1m', limit: 60 })
    ```
  </Step>
  
  <Step title="Adicionar Audit Log (opera√ß√µes cr√≠ticas)">
    ```typescript
    await createAuditLog(user.id, 'action.performed', {
      resource_type: 'resource',
      resource_id: 'id',
      details: { ip, user_agent }
    })
    ```
  </Step>
</Steps>

---

<Info>
O sistema de autentica√ß√£o foi projetado para alta seguran√ßa mantendo simplicidade de uso. Sempre valide permiss√µes em cada endpoint e use HTTPS em produ√ß√£o.
</Info>